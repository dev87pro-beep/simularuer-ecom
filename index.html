<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senix Flow | نسخة التصحيح</title>
    <!-- مكتبة الأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- خط عربي (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-app: #f8fafc;
            --bg-sidebar: #0f172a;
            --bg-white: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --color-primary: #6366f1;
            --color-accent: #0ea5e9;
            --color-danger: #ef4444;
            --border: #e2e8f0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg-app); color: var(--text-main); min-height: 100vh; display: flex; }

        /* Loading */
        #debug-screen { position: fixed; inset: 0; background: var(--bg-app); z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--color-accent); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .debug-msg { color: var(--color-danger); font-weight: 700; font-size: 1.2rem; text-align: center; display: none; }
        .debug-info { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; display: none; }

        /* Auth */
        #auth-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #0f172a, #1e293b); z-index: 9999; display: flex; align-items: center; justify-content: center; display: none; }
        .auth-box { background: white; padding: 40px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .auth-title { margin-bottom: 30px; font-size: 1.5rem; color: #333; }
        .auth-input { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-family: inherit; }
        .auth-btn { width: 100%; padding: 15px; background: var(--color-primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        
        /* App */
        #app { display: none; width: 100%; flex-direction: row; min-height: 100vh; }
        .sidebar { width: 250px; background: var(--bg-sidebar); color: white; display: flex; flex-direction: column; padding: 20px; }
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .kpi { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: bold; font-size: 1.5rem; color: var(--color-primary); }
        
        /* Helper Classes */
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; background: var(--color-primary); color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>

    <!-- 1. LOADING SCREEN -->
    <div id="debug-screen">
        <div class="spinner"></div>
        <p style="color: var(--text-muted);">جاري تحميل النظام...</p>
        
        <!-- Error Message Placeholder -->
        <div id="debug-error" class="debug-msg">
            خطأ في الاتصال بالسيرفر<br>
            يرجى فتح Console (F12) لرؤية التفاصيل
        </div>
        
        <!-- Info Placeholder -->
        <div id="debug-info" class="debug-info">
            حالة الاتصال: <span id="status-text" style="font-weight:bold; color:green;">جاري الاتصال...</span><br>
            Config: <span id="config-status">لم يتم التحقق</span>
        </div>
    </div>

    <!-- 2. AUTH SCREEN -->
    <div id="auth-screen" class="hidden">
        <div class="auth-box">
            <h2 class="auth-title">تسجيل الدخول</h2>
            <input type="email" id="email" class="auth-input" placeholder="البريد الإلكتروني">
            <input type="password" id="password" class="auth-input" placeholder="كلمة المرور">
            <button class="auth-btn" onclick="attemptLogin()">دخول</button>
            <p style="font-size: 0.9rem; color: #666;">ملاحظة: تأكد من إنشاء المستخدم يدوياً في Firebase Console</p>
        </div>
    </div>

    <!-- 3. MAIN APP -->
    <div id="app" class="hidden">
        <nav class="sidebar">
            <h3>Senix Flow</h3>
            <ul style="list-style: none; padding: 0;">
                <li style="margin-bottom: 15px;"><button class="btn hidden" onclick="alert('سيتم عرض المحتوى')">الرئيسية</button></li>
                <li style="margin-bottom: 15px;"><button class="btn hidden" onclick="alert('سيتم عرض المحتوى')">المخزون</button></li>
                <li style="margin-bottom: 15px;"><button class="btn hidden" onclick="alert('سيتم عرض المحتوى')">الحاسبة</button></li>
            </ul>
            <div style="margin-top: auto;">
                <p id="user-display" style="font-size: 0.9rem;">غير مسجل</p>
                <button onclick="logout()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid white;">خروج</button>
            </div>
        </nav>
        <main class="main">
            <div class="kpi">عدد المنتجات: <span id="total-count">0</span></div>
            <p style="text-align: center; color: #999; margin-top: 50px;">نظام قيد التشغيل بنجاح</p>
        </main>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        // --- 1. Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";

        // --- 2. Config ---
const firebaseConfig = {
  apiKey: "AIzaSyDOfw9W2U1o5HGjtcUfnQhjudoQnqFccBk",
  authDomain: "my-store-app-12651.firebaseapp.com",
  projectId: "my-store-app-12651",
  storageBucket: "my-store-app-12651.firebasestorage.app",
  messagingSenderId: "52453040648",
  appId: "1:52453040648:web:a8101a86e030c559f967bd"
};

        // --- 3. Debug Logic ---
        const statusText = document.getElementById('status-text');
        const configStatus = document.getElementById('config-status');
        
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            showError("خطأ: لم يتم وضع ملفات الربط (firebaseConfig) بشكل صحيح.");
            statusText.innerText = "خطأ في الإعداد";
            statusText.style.color = "red";
            return; // Stop execution
        } else {
            statusText.innerText = "تم التحقق من الـ Config";
            statusText.style.color = "green";
            configStatus.innerText = "تم العثور على الـ API Key";
        }

        // --- 4. Initialize ---
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            console.log("Firebase Initialized Successfully");
            statusText.innerText = "تم الاتصال بـ Firebase";

            // --- 5. Auth State ---
            onAuthStateChanged(auth, (user) => {
                const loading = document.getElementById('debug-screen');
                const authScreen = document.getElementById('auth-screen');
                const mainApp = document.getElementById('app');
                const debugInfo = document.getElementById('debug-info');

                if (user) {
                    loading.style.display = 'none';
                    authScreen.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    debugInfo.style.display = 'block';
                    
                    document.getElementById('user-display').innerText = user.email;
                    
                    // Load basic data to test connection
                    getDocs(collection(db, 'inventory')).then(snap => {
                        document.getElementById('total-count').innerText = snap.size;
                    });
                    
                } else {
                    loading.style.display = 'none';
                    authScreen.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                }
            });

            // --- 6. Window Functions ---
            window.attemptLogin = async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if(!email || !password) {
                    alert("يرجى إدخال البيانات");
                    return;
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error(error);
                    alert("خطأ في تسجيل الدخول: " + error.message);
                }
            };

            window.logout = () => {
                signOut(auth);
                window.location.reload();
            };

        } catch (e) {
            console.error("Initialization Error:", e);
            showError("خطأ في تهيئة Firebase: " + e.message);
        }

        function showError(msg) {
            document.getElementById('debug-screen').classList.add('hidden');
            document.getElementById('debug-error').style.display = 'block';
            document.getElementById('debug-error').innerText = msg;
            document.getElementById('debug-info').style.display = 'block';
        }
    </script>
</body>
</html>
