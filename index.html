<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProInventory | Profit & Stock Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Professional Color Palette */
            --primary: #4F46E5; /* Indigo */
            --primary-hover: #4338ca;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-sidebar: #0f172a; /* Dark Navy */
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-light: #94a3b8;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius: 10px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            right: 0; /* Default LTR logic handled via dir=ltr */
            z-index: 100;
            transition: var(--transition);
        }

        .brand {
            padding: 1.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand span { color: var(--primary); background: white; padding: 2px 8px; border-radius: 4px; }

        .nav-links {
            padding: 1rem;
            list-style: none;
            flex: 1;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0.75rem 1rem;
            color: var(--text-light);
            text-decoration: none;
            border-radius: var(--radius);
            transition: var(--transition);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-link svg { width: 20px; height: 20px; }

        /* Main Content */
        .main-content {
            margin-right: 260px; /* Offset for sidebar */
            flex: 1;
            padding: 2rem;
            transition: var(--transition);
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title h1 { font-size: 1.5rem; font-weight: 700; }
        .page-title p { color: var(--text-light); font-size: 0.9rem; margin-top: 4px; }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .avatar {
            width: 40px; height: 40px;
            background: var(--primary);
            border-radius: 50%;
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .stat-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .stat-icon { 
            padding: 10px; border-radius: 8px; 
            background: #e0e7ff; color: var(--primary); 
        }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
        .stat-label { color: var(--text-light); font-size: 0.85rem; font-weight: 500; }
        .stat-trend { font-size: 0.8rem; margin-top: 0.5rem; display: flex; align-items: center; gap: 5px; }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Sections Logic */
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Calculator & Form Styling */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .card-header { margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.1rem; font-weight: 600; }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .form-group { margin-bottom: 0.5rem; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-main); margin-bottom: 0.5rem; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: var(--transition);
            background: #f8fafc;
        }
        .form-group input:focus { border-color: var(--primary); background: white; outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        .input-prefix { position: relative; }
        .input-prefix span { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-light); font-weight: 600; }
        .input-prefix input { padding-left: 30px; }

        /* Live Result Box */
        .live-results {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            border: 1px solid var(--border);
            margin-top: 1.5rem;
        }

        .result-item h4 { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; }
        .result-item .value { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .result-item.profit .value { color: var(--success); }
        .result-item.loss .value { color: var(--danger); }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.95rem;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        .btn-danger { background: #fee2e2; color: #b91c1c; padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-danger:hover { background: #fecaca; }

        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 1rem; background: #f8fafc; color: var(--text-light); font-weight: 600; border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text-main); }
        tr:hover { background: #f8fafc; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }

        .action-btns { display: flex; gap: 5px; }
        .action-btn { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: 0.2s; }
        .action-btn:hover { background: #e2e8f0; }

        /* Toast */
        #toast {
            position: fixed; bottom: 20px; left: 20px;
            background: #1e293b; color: white;
            padding: 1rem 1.5rem; border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            transform: translateY(100px); opacity: 0;
            transition: 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
            display: flex; align-items: center; gap: 10px;
        }
        #toast.show { transform: translateY(0); opacity: 1; }
        #toast.success { border-right: 4px solid var(--success); }
        #toast.error { border-right: 4px solid var(--danger); }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-right: 0; }
            .mobile-menu-btn { display: block; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <span>PRO</span> Inventory
        </div>
        <ul class="nav-links">
            <li class="nav-item">
                <a onclick="showSection('dashboard')" class="nav-link active" id="nav-dashboard">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a onclick="showSection('calculator')" class="nav-link" id="nav-calculator">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 3.666V14a2 2 0 11-4 0v-2.334C11 9.667 11 9.667 11 9.667S11 9 9 7m0 0v-.866c0-1.424 1.063-2.667 2.5-2.667S14 4.71 14 6.134V7"></path></svg>
                    Calculator
                </a>
            </li>
            <li class="nav-item">
                <a onclick="showSection('inventory')" class="nav-link" id="nav-inventory">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                    Inventory
                </a>
            </li>
            <li class="nav-item">
                <a onclick="showSection('settings')" class="nav-link" id="nav-settings">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings
                </a>
            </li>
        </ul>
        <div style="padding: 1.5rem; margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 0.75rem; color: #64748b;">ProInventory v1.0</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <div class="top-bar">
            <div class="page-title">
                <h1 id="page-header-title">Dashboard</h1>
                <p id="page-header-subtitle">Overview of your business performance</p>
            </div>
            <div class="user-profile">
                <div style="text-align: left;">
                    <div style="font-weight: 600; font-size: 0.9rem;">Admin User</div>
                    <div style="font-size: 0.8rem; color: var(--text-light);">Owner</div>
                </div>
                <div class="avatar">A</div>
            </div>
        </div>

        <!-- DASHBOARD SECTION -->
        <section id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Total Products</div>
                            <div class="stat-value" id="dash-total-items">0</div>
                        </div>
                        <div class="stat-icon"><svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg></div>
                    </div>
                    <div class="stat-trend trend-up">Items in stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Potential Profit</div>
                            <div class="stat-value" id="dash-total-profit">$0.00</div>
                        </div>
                        <div class="stat-icon"><svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    </div>
                    <div class="stat-trend trend-up">Based on current stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Low Stock Alerts</div>
                            <div class="stat-value" style="color:var(--warning)" id="dash-low-stock">0</div>
                        </div>
                        <div class="stat-icon" style="color:var(--warning); background:#fef3c7"><svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                    </div>
                    <div class="stat-trend trend-down">Items below 5 units</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Average Margin</div>
                            <div class="stat-value" id="dash-avg-margin">0%</div>
                        </div>
                        <div class="stat-icon" style="color:var(--primary); background:#e0e7ff"><svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg></div>
                    </div>
                    <div class="stat-trend">Profitability health</div>
                </div>
            </div>
        </section>

        <!-- CALCULATOR SECTION -->
        <section id="calculator" class="section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Product Profit Calculator</h3>
                    <button class="btn btn-outline" onclick="resetForm()">Reset Form</button>
                </div>

                <div class="form-grid">
                    <!-- Basic Info -->
                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="inp-name" placeholder="e.g. Wireless Headphones">
                    </div>
                    <div class="form-group">
                        <label>SKU / ID</label>
                        <input type="text" id="inp-sku" placeholder="SKU-001">
                    </div>
                    
                    <!-- Buying Costs -->
                    <div class="form-group">
                        <label>Purchase Price</label>
                        <div class="input-prefix">
                            <input type="number" id="inp-cost" class="calc-input" placeholder="0.00" step="0.01">
                            <span id="currency-purchase-label">$</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Shipping Cost (to you)</label>
                        <div class="input-prefix">
                            <input type="number" id="inp-ship" class="calc-input" placeholder="0.00" step="0.01">
                            <span id="currency-ship-label">$</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Packaging & Other</label>
                        <div class="input-prefix">
                            <input type="number" id="inp-pack" class="calc-input" placeholder="0.00" step="0.01">
                            <span>$</span>
                        </div>
                    </div>

                    <!-- Selling & Marketing -->
                    <div class="form-group">
                        <label>Selling Price</label>
                        <div class="input-prefix">
                            <input type="number" id="inp-sell" class="calc-input" placeholder="0.00" step="0.01">
                            <span>$</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ad Cost (per order)</label>
                        <div class="input-prefix">
                            <input type="number" id="inp-ads" class="calc-input" placeholder="0.00" step="0.01">
                            <span>$</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Initial Stock Qty</label>
                        <input type="number" id="inp-qty" value="10">
                    </div>
                </div>

                <!-- Live Calculation Preview -->
                <div class="live-results">
                    <div class="result-item">
                        <h4>Total Cost</h4>
                        <div class="value" id="res-cost">$0.00</div>
                    </div>
                    <div class="result-item" id="res-profit-box">
                        <h4>Net Profit</h4>
                        <div class="value" id="res-profit">$0.00</div>
                    </div>
                    <div class="result-item">
                        <h4>Margin</h4>
                        <div class="value" id="res-margin">0%</div>
                    </div>
                    <div class="result-item">
                        <h4>Status</h4>
                        <div class="value" style="font-size: 1rem; color: var(--text-light);" id="res-status">Waiting...</div>
                    </div>
                </div>

                <div style="margin-top: 2rem; text-align: right;">
                    <button class="btn btn-primary" onclick="addProduct()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Add to Inventory
                    </button>
                </div>
            </div>
        </section>

        <!-- INVENTORY SECTION -->
        <section id="inventory" class="section">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Inventory List</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="search-box" placeholder="Search products..." onkeyup="renderInventory()" style="padding:0.5rem; border:1px solid var(--border); border-radius:6px;">
                        <button class="btn btn-outline" onclick="exportCSV()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export CSV
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Sell Price</th>
                                <th>Total Cost</th>
                                <th>Profit</th>
                                <th>Margin</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body">
                            <!-- JS Injection -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-state" style="text-align:center; padding:3rem; color:var(--text-light); display:none;">
                    No products found. Add one using the Calculator.
                </div>
            </div>
        </section>

        <!-- SETTINGS SECTION -->
        <section id="settings" class="section">
            <div class="card" style="max-width: 600px;">
                <div class="card-header">
                    <h3 class="card-title">Global Settings</h3>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Platform Commission (%)</label>
                    <input type="number" id="set-platform" placeholder="e.g. 5 for 5%" value="0">
                    <small style="color:var(--text-light)">e.g. Shopify, Amazon, eBay fee percentage.</small>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Fixed Payment Fee ($)</label>
                    <input type="number" id="set-fixed" placeholder="0.00" value="0">
                    <small style="color:var(--text-light)">e.g. Stripe/PayPal fixed fee per transaction.</small>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Purchase Currency Exchange Rate (to $)</label>
                    <input type="number" id="set-exchange" placeholder="1.00" value="1.00" step="0.01">
                    <small style="color:var(--text-light)">If you buy in CNY/AED, enter how much 1 unit is in USD. (Default 1.00).</small>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Configuration</button>
            </div>
        </section>

    </main>

    <!-- Toast Notification -->
    <div id="toast">
        <span id="toast-icon">âœ“</span>
        <span id="toast-msg">Operation successful</span>
    </div>

    <script>
        // --- State Management ---
        let products = [];
        let settings = {
            platformPercent: 0,
            fixedFee: 0,
            exchangeRate: 1.00 // 1 Purchase Unit = X USD
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
            updateDashboard();
            renderInventory();
            updateSettingsUI();
        });

        function setupEventListeners() {
            const inputs = document.querySelectorAll('.calc-input');
            inputs.forEach(input => input.addEventListener('input', calculateLive));
        }

        // --- Navigation ---
        function showSection(id) {
            // Update active links
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('nav-' + id).classList.add('active');

            // Show section
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            // Update Header
            const titles = {
                'dashboard': ['Dashboard', 'Overview of your business performance'],
                'calculator': ['Calculator', 'Analyze product costs and profits'],
                'inventory': ['Inventory', 'Manage stock and product details'],
                'settings': ['Settings', 'Configure fees and currencies']
            };
            document.getElementById('page-header-title').innerText = titles[id][0];
            document.getElementById('page-header-subtitle').innerText = titles[id][1];

            if(id === 'inventory') renderInventory();
            if(id === 'dashboard') updateDashboard();
        }

        // --- Calculator Logic ---
        function calculateLive() {
            const cost = parseFloat(document.getElementById('inp-cost').value) || 0;
            const ship = parseFloat(document.getElementById('inp-ship').value) || 0;
            const pack = parseFloat(document.getElementById('inp-pack').value) || 0;
            const sell = parseFloat(document.getElementById('inp-sell').value) || 0;
            const ads = parseFloat(document.getElementById('inp-ads').value) || 0;

            // Calculate Fees
            const platformFee = (sell * (settings.platformPercent / 100));
            const totalFee = platformFee + settings.fixedFee;

            const totalCost = (cost * settings.exchangeRate) + (ship * settings.exchangeRate) + pack + ads + totalFee;
            const profit = sell - totalCost;
            const margin = sell > 0 ? ((profit / sell) * 100).toFixed(1) : 0;

            // UI Updates
            document.getElementById('res-cost').innerText = formatMoney(totalCost);
            const profitEl = document.getElementById('res-profit');
            profitEl.innerText = formatMoney(profit);
            
            const box = document.getElementById('res-profit-box');
            const status = document.getElementById('res-status');

            if (profit > 0) {
                box.className = 'result-item profit';
                status.innerText = 'Profitable';
                status.style.color = 'var(--success)';
            } else if (profit < 0) {
                box.className = 'result-item loss';
                status.innerText = 'Loss';
                status.style.color = 'var(--danger)';
            } else {
                box.className = 'result-item';
                status.innerText = 'Break-even';
                status.style.color = 'var(--text-light)';
            }

            document.getElementById('res-margin').innerText = margin + '%';
        }

        // --- Core Functions ---
        function addProduct() {
            const name = document.getElementById('inp-name').value;
            const sku = document.getElementById('inp-sku').value;
            const qty = parseInt(document.getElementById('inp-qty').value) || 0;

            if (!name) {
                showToast('Please enter a product name', 'error');
                return;
            }

            // Recalculate logic (duplicate of live calc to ensure data integrity)
            const cost = parseFloat(document.getElementById('inp-cost').value) || 0;
            const ship = parseFloat(document.getElementById('inp-ship').value) || 0;
            const pack = parseFloat(document.getElementById('inp-pack').value) || 0;
            const sell = parseFloat(document.getElementById('inp-sell').value) || 0;
            const ads = parseFloat(document.getElementById('inp-ads').value) || 0;

            const platformFee = (sell * (settings.platformPercent / 100));
            const totalFee = platformFee + settings.fixedFee;
            const totalCost = (cost * settings.exchangeRate) + (ship * settings.exchangeRate) + pack + ads + totalFee;
            const profit = sell - totalCost;
            const margin = sell > 0 ? ((profit / sell) * 100) : 0;

            const product = {
                id: Date.now(),
                name, sku,
                sellPrice: sell,
                costPrice: totalCost, // Total cost in USD
                profit: profit,
                margin: margin,
                stock: qty,
                date: new Date().toISOString()
            };

            products.push(product);
            saveData();
            showToast('Product added successfully!', 'success');
            resetForm();
            showSection('inventory'); // Redirect
        }

        function deleteProduct(id) {
            if(confirm('Are you sure you want to delete this product?')) {
                products = products.filter(p => p.id !== id);
                saveData();
                renderInventory();
                updateDashboard();
            }
        }

        function adjustStock(id, amount) {
            const p = products.find(x => x.id === id);
            if(p) {
                const newQty = p.stock + amount;
                if(newQty >= 0) {
                    p.stock = newQty;
                    saveData();
                    renderInventory();
                }
            }
        }

        // --- Rendering ---
        function renderInventory() {
            const tbody = document.getElementById('inventory-body');
            const search = document.getElementById('search-box').value.toLowerCase();
            const empty = document.getElementById('empty-state');
            
            tbody.innerHTML = '';
            
            const filtered = products.filter(p => p.name.toLowerCase().includes(search) || p.sku.toLowerCase().includes(search));

            if(filtered.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            filtered.forEach(p => {
                let badgeClass = 'badge-success';
                let statusText = 'Good';
                if(p.stock < 5) { badgeClass = 'badge-danger'; statusText = 'Low Stock'; }
                else if (p.margin < 10) { badgeClass = 'badge-warning'; statusText = 'Low Margin'; }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:600">${p.name}</td>
                    <td style="color:var(--text-light)">${p.sku}</td>
                    <td>${formatMoney(p.sellPrice)}</td>
                    <td>${formatMoney(p.costPrice)}</td>
                    <td style="color:${p.profit >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight:600">${formatMoney(p.profit)}</td>
                    <td>${p.margin.toFixed(1)}%</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <button class="btn-danger" onclick="adjustStock(${p.id}, -1)">-</button>
                            <span style="min-width:20px; text-align:center; font-weight:600">${p.stock}</span>
                            <button class="btn-primary" style="padding:0.2rem 0.6rem; font-size:0.8rem" onclick="adjustStock(${p.id}, 1)">+</button>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${badgeClass}" style="margin-left:5px">${statusText}</span>
                        <button class="action-btn" onclick="deleteProduct(${p.id})" title="Delete">ðŸ—‘</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateDashboard() {
            document.getElementById('dash-total-items').innerText = products.length;
            
            let totalProfit = 0;
            let lowStock = 0;
            let totalMargin = 0;

            products.forEach(p => {
                totalProfit += (p.profit * p.stock);
                if(p.stock < 5) lowStock++;
                totalMargin += p.margin;
            });

            const avgMargin = products.length ? (totalMargin / products.length).toFixed(1) : 0;

            document.getElementById('dash-total-profit').innerText = formatMoney(totalProfit);
            document.getElementById('dash-low-stock').innerText = lowStock;
            document.getElementById('dash-avg-margin').innerText = avgMargin + '%';
        }

        function updateSettingsUI() {
            document.getElementById('set-platform').value = settings.platformPercent;
            document.getElementById('set-fixed').value = settings.fixedFee;
            document.getElementById('set-exchange').value = settings.exchangeRate;
            
            // Update currency labels in calculator
            const currLabel = settings.exchangeRate === 1 ? '$' : '~$';
            document.getElementById('currency-purchase-label').innerText = currLabel;
            document.getElementById('currency-ship-label').innerText = currLabel;
        }

        function saveSettings() {
            settings.platformPercent = parseFloat(document.getElementById('set-platform').value) || 0;
            settings.fixedFee = parseFloat(document.getElementById('set-fixed').value) || 0;
            settings.exchangeRate = parseFloat(document.getElementById('set-exchange').value) || 1;

            localStorage.setItem('proinv_settings', JSON.stringify(settings));
            
            // Recalculate all products with new settings
            products.forEach(p => {
                // Note: In a real app we would store original components (cost, ship, ads) separately to re-calc.
                // For this simpler version, we will alert user that only NEW products use new fees, 
                // OR we try to reverse calc (complex). 
                // Let's stick to: Settings apply to NEW products + Live Calc updates immediately.
            });

            updateSettingsUI();
            calculateLive(); // Update live preview immediately
            showToast('Settings saved', 'success');
        }

        // --- Utilities ---
        function formatMoney(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        function resetForm() {
            document.getElementById('inp-name').value = '';
            document.getElementById('inp-sku').value = '';
            document.querySelectorAll('.calc-input').forEach(i => i.value = '');
            document.getElementById('inp-qty').value = 10;
            calculateLive();
        }

        function saveData() {
            localStorage.setItem('proinv_products', JSON.stringify(products));
        }

        function loadData() {
            const p = localStorage.getItem('proinv_products');
            const s = localStorage.getItem('proinv_settings');
            if(p) products = JSON.parse(p);
            if(s) settings = JSON.parse(s);
        }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const txt = document.getElementById('toast-msg');
            
            t.className = `show ${type}`;
            icon.innerText = type === 'success' ? 'âœ“' : '!';
            txt.innerText = msg;

            setTimeout(() => {
                t.classList.remove('show');
            }, 3000);
        }

        function exportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Name,SKU,Sell Price,Total Cost,Profit,Margin,Stock\n";

            products.forEach(function(p) {
                let row = `${p.name},${p.sku},${p.sellPrice},${p.costPrice},${p.profit},${p.margin},${p.stock}`;
                csvContent += row + "\n";
            });

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "inventory_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
