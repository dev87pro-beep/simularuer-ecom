<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة إدارة متقدمة | Production Version</title>
    <!-- مكتبة الأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- خط عربي (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- Semantic Palette --- */
            /* الخلفيات */
            --bg-white: #ffffff;
            --bg-sidebar: #1e293b;

            /* النصوص */
            --text-main: #1f2937;
            --text-muted: #64748b;
            --text-white: #f8fafc;

            /* ألوان الأيقونات والوظائف (Semantic) */
            --color-dashboard: #3b82f6;   /* أزرق */
            --color-inventory: #d97706;   /* بني */
            --color-shipping: #0ea5e9;    /* أزرق محيطي */
            --color-winning: #f59e0b;     /* برتقالي */
            --color-pages: #8b5cf6;        /* بنفسجي */
            --color-calc: #10b981;          /* أخضر */
            --color-success: #10b981;       /* أخضر للإضافة */
            --color-edit: #64748b;          /* رمادي للتعديل */
            --color-delete: #ef4444;       /* أحمر للحذف */
            --color-warning: #f59e0b;       /* برتقالي للتنبيه */
            
            /* حدود وظلال */
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-white);
            color: var(--text-main);
            display: flex;
            min-height: 100vh;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            color: var(--text-white);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            right: 0;
            top: 0;
            z-index: 50;
            border-left: 1px solid rgba(255,255,255,0.1);
            box-shadow: -5px 0 25px rgba(0,0,0,0.2);
        }

        .sidebar-header {
            padding: 35px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .sidebar-header h2 { font-size: 1.4rem; font-weight: 700; color: var(--text-white); }

        .nav-links { list-style: none; padding: 20px 0; flex-grow: 1; }
        .nav-links li { margin-bottom: 10px; }
        
        .nav-links a {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: #9ca3af;
            text-decoration: none;
            transition: all 0.2s ease;
            border-radius: 10px;
            font-weight: 500;
        }

        .nav-links a:hover {
            background-color: rgba(255,255,255,0.1);
            color: var(--text-white);
            transform: translateX(-5px);
        }

        .nav-links a.active {
            background-color: var(--color-dashboard);
            color: var(--text-white);
        }

        .nav-links a i { margin-left: 15px; width: 22px; text-align: center; font-size: 1.2rem; }

        /* --- Main Content --- */
        .main-content {
            margin-right: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding: 40px;
            transition: all 0.3s ease;
            background-color: var(--bg-white);
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            background: var(--bg-white);
            padding: 25px 30px;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }
        header h1 { font-size: 1.8rem; font-weight: 800; color: var(--text-main); }

        /* --- Sections Visibility --- */
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 30px;
            grid-auto-rows: min-content;
        }

        /* --- 1. KPI Cards (Enhanced) --- */
        .kpi-section { grid-column: span 12; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; }

        .kpi-card {
            background: var(--bg-white);
            padding: 30px;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }

        .kpi-info h4 { font-size: 0.9rem; color: var(--text-muted); font-weight: 600; margin-bottom: 8px; }
        .kpi-info p { font-size: 2rem; font-weight: 800; color: var(--text-main); }
        .kpi-icon { font-size: 2.5rem; opacity: 0.1; }

        /* --- 2. Actions Section --- */
        .actions-section { grid-column: span 12; margin-bottom: 30px; }
        .actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; }
        
        .action-card {
            background: var(--bg-white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }
        .action-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--color-dashboard); }
        
        .action-card i { font-size: 2rem; color: var(--text-muted); margin-bottom: 10px; transition: 0.2s; }
        .action-card:hover i { color: var(--color-dashboard); }
        .action-card span { font-weight: 700; font-size: 1rem; color: var(--text-main); }

        .act-blue:hover { border-color: var(--color-dashboard); }
        .act-green:hover { border-color: var(--color-winning); }
        .act-orange:hover { border-color: var(--color-shipping); }
        .act-purple:hover { border-color: var(--color-pages); }

        /* --- 3. Winning Section --- */
        .winning-section { grid-column: span 8; display: flex; flex-direction: column; gap: 30px; }
        .card {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            padding: 30px;
            height: 100%;
            border: 1px solid var(--border);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #f3f4f6; padding-bottom: 20px; }
        .card-header h3 { font-size: 1.3rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        
        .top-list { display: flex; flex-direction: column; gap: 20px; }
        .top-item {
            display: flex; align-items: center; justify-content: space-between;
            background: #f9fafb; padding: 15px 25px;
            border-radius: 12px;
            border-right: 4px solid transparent;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        .top-item:hover { background: #fff; box-shadow: var(--shadow-md); border-right-color: var(--color-winning); transform: translateX(-5px); }
        
        .item-info { display: flex; align-items: center; gap: 15px; flex-grow: 1; }
        .item-img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; border: 1px solid var(--border); }
        .item-name { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .item-sub { font-size: 0.9rem; color: var(--text-muted); }
        .item-metrics { display: flex; align-items: center; gap: 15px; }
        .metric-badge { background: #f0f9ff; color: var(--color-dashboard); padding: 6px 16px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }
        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: none; cursor: pointer; transition: 0.2s; color: white; }
        .btn-icon:hover { transform: scale(1.1); }
        .bg-green { background: var(--color-success); }
        .bg-red { background: var(--color-delete); }

        /* --- 4. Weak Products Section --- */
        .weak-section { grid-column: span 4; display: flex; flex-direction: column; gap: 30px; }
        .weak-row { display: flex; justify-content: space-between; padding: 18px 25px; background: #fff7ed; border-radius: 12px; margin-bottom: 15px; font-size: 0.95rem; color: var(--text-main); border-right: 4px solid transparent; transition: 0.3s; }
        .weak-row:hover { background: #fff; box-shadow: var(--shadow-sm); border-right-color: var(--color-warning); transform: translateX(-5px); }
        .weak-row strong { font-weight: 700; flex-grow: 1; }
        .weak-row span:last-child { font-weight: 700; color: var(--color-warning); font-size: 0.9rem; }

        /* --- 5. Stock Section (Hidden in favor of Weak/All) --- */
        .stock-section { display: none; }

        /* --- 6. Full Sections --- */
        .card-grid-full { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .product-card { background: var(--bg-white); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow-sm); border: 1px solid var(--border); transition: 0.3s; }
        .product-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-lg); }
        .product-img { width: 100%; height: 220px; object-fit: cover; border-bottom: 1px solid #f3f4f6; background-color: #f3f4f6; }
        .product-body { padding: 30px; }
        .product-title { font-weight: 700; font-size: 1.3rem; margin-bottom: 15px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-meta { font-size: 1rem; color: var(--text-muted); margin-bottom: 12px; display: flex; justify-content: space-between; }
        .product-actions { padding: 20px 30px; border-top: 1px solid #f3f4f6; display: flex; justify-content: flex-end; gap: 15px; }
        .badge { padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; display: inline-block; }
        .badge-success { background: #d1fae5; color: #065f46; } /* Available */
        .badge-warning { background: #fef3c7; color: #92400e; } /* Importing */
        .badge-danger { background: #fee2e2; color: #b91c1c; } /* Invalid */
        .badge-neutral { background: #f3f4f6; color: #4b5563; } /* Unavailable */
        
        .status-text { font-weight: 700; font-size: 0.9rem; margin-top: 8px; }
        .status-success { color: var(--color-success); }
        .status-danger { color: var(--color-delete); }

        /* --- 7. Pages Section --- */
        .pages-section { grid-column: span 8; display: flex; flex-direction: column; gap: 30px; }
        .page-link { display: flex; justify-content: space-between; padding: 18px 25px; background: #f9fafb; border-radius: 12px; text-decoration: none; font-weight: 700; margin-bottom: 15px; border: 1px solid transparent; align-items: center; color: var(--text-main); transition: 0.3s; }
        .page-link:hover { background: #fff; transform: translateX(-5px); box-shadow: var(--shadow-sm); border-color: var(--color-pages); color: var(--color-pages); }
        .page-icon { color: var(--color-pages); }

        /* --- 8. Calculator --- */
        .calc-wrapper { background: var(--bg-white); padding: 50px; border-radius: 20px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); max-width: 1000px; margin: 0 auto; }
        .calc-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .calc-group { margin-bottom: 30px; position: relative; }
        .calc-group label { display: block; margin-bottom: 12px; font-weight: 600; color: var(--text-main); font-size: 1.1rem; }
        .calc-group i { position: absolute; left: 25px; top: 50%; transform: translateY(-50%); color: var(--color-calc); font-size: 1.3rem; }
        .calc-control { width: 100%; padding: 16px 25px 16px 50px; border: 1px solid #e2e8f0; border-radius: 12px; font-family: inherit; font-size: 1.1rem; background: #f9fafb; transition: 0.3s; }
        .calc-control:focus { border-color: var(--color-dashboard); background: #fff; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .calc-res { margin-top: 40px; padding: 30px; background: #f9fafb; border-radius: 16px; border: 1px dashed #e2e8f0; display: flex; justify-content: space-around; text-align: center; }
        .res-box { flex: 1; }
        .res-box h5 { font-size: 1rem; color: var(--text-muted); margin-bottom: 12px; font-weight: 600; }
        .res-box span { font-size: 2rem; font-weight: 800; color: var(--text-main); }

        /* --- 9. Modal --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
        .modal.open { display: flex; opacity: 1; }
        .modal-content { background: var(--bg-white); padding: 40px; border-radius: 20px; width: 100%; max-width: 600px; position: relative; transform: scale(0.9); transition: transform 0.3s; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1); max-height: 90vh; overflow-y: auto; }
        .modal.open .modal-content { transform: scale(1); }
        .close-modal { position: absolute; left: 30px; top: 30px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 50%; color: var(--text-muted); font-size: 2rem; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .close-modal:hover { background: #fee2e2; color: var(--color-delete); }
        
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-main); font-size: 1.1rem; }
        .form-input { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-family: inherit; font-size: 1.1rem; background: #f9fafb; transition: 0.3s; }
        .form-input:focus { border-color: var(--color-dashboard); background: #fff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .form-textarea { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-family: inherit; font-size: 1.1rem; background: #f9fafb; transition: 0.3s; resize: vertical; min-height: 100px; }
        
        .btn { padding: 14px 30px; border: none; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 700; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 10px; color: white; }
        .btn-primary { background: var(--color-dashboard); }
        .btn-success { background: var(--color-success); }
        .btn-warning { background: var(--color-shipping); }
        .btn-purple { background: var(--color-pages); }
        .btn-icon-sm { width: 40px; height: 40px; padding: 0; border-radius: 10px; border: none; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-icon-sm:hover { transform: scale(1.1); }
        
        /* Semantic Button Colors */
        .btn-inventory { background: var(--color-inventory); }
        .btn-winning { background: var(--color-winning); }
        .btn-importing { background: var(--color-shipping); }

        /* --- 10. Toast --- */
        .toast-container { position: fixed; bottom: 40px; left: 40px; z-index: 2000; display: flex; flex-direction: column; gap: 15px; }
        .toast { background: var(--text-main); color: white; padding: 18px 30px; border-radius: 10px; box-shadow: 0 10px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px; min-width: 350px; border-right: 6px solid var(--color-success); animation: slideIn 0.5s; }
        .toast.error { border-right-color: var(--color-delete); }
        @keyframes slideIn { from { transform: translateX(-80px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- Toolbar --- */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .toolbar h2 { font-size: 1.8rem; font-weight: 800; color: var(--text-main); }
        
        /* Image Upload Preview */
        .image-preview { 
            width: 100%; height: 160px; 
            background: #f9fafb; 
            border: 2px dashed #cbd5e1; 
            border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            margin-bottom: 25px; cursor: pointer; overflow: hidden;
            position: relative; 
        }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview-placeholder { text-align: center; color: var(--text-muted); }
        .image-preview-placeholder i { font-size: 2rem; margin-bottom: 10px; color: var(--color-dashboard); }
        .image-preview:hover { border-color: var(--color-dashboard); background: #eff6ff; }

        /* --- Responsive --- */
        @media (max-width: 1024px) {
            .dashboard-grid > div { grid-column: span 12; }
            .winning-section, .weak-section, .pages-section { grid-column: span 12; }
            .calc-inputs { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-right: 0; width: 100%; padding: 25px; }
            .toggle-menu { display: block; font-size: 1.8rem; cursor: pointer; margin-left: 25px; color: var(--text-main); }
        }
        @media (min-width: 769px) { .toggle-menu { display: none; } }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); background: #fff; border-radius: 16px; border: 2px dashed #e5e7eb; grid-column: 1 / -1; }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-layer-group fa-2x" style="color: var(--color-dashboard);"></i>
            <h2>لوحة الإدارة</h2>
        </div>
        <ul class="nav-links">
            <li><a href="#" onclick="switchTab('dashboard')" class="active"><i class="fas fa-th-large" style="color: var(--color-dashboard);"></i> الرئيسية</a></li>
            <li><a href="#" onclick="switchTab('inventory')"><i class="fas fa-boxes" style="color: var(--color-inventory);"></i> المخزون</a></li>
            <li><a href="#" onclick="switchTab('importing')"><i class="fas fa-shipping-fast" style="color: var(--color-shipping);"></i> الاستيراد</a></li>
            <li><a href="#" onclick="switchTab('winning')"><i class="fas fa-trophy" style="color: var(--color-winning);"></i> المنتجات الرابحة</a></li>
            <li><a href="#" onclick="switchTab('pages')"><i class="fas fa-store" style="color: var(--color-pages);"></i> أفضل الصفحات</a></li>
            <li><a href="#" onclick="switchTab('calculator')"><i class="fas fa-calculator" style="color: var(--color-calc);"></i> الآلة الحاسبة</a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <header>
            <div style="display:flex; align-items:center;">
                <i class="fas fa-bars toggle-menu" style="color: var(--text-main);"></i>
                <h1>لوحة التحكم الشاملة</h1>
            </div>
            <div style="display:flex; align-items:center; gap:20px;">
                <div style="text-align:left;">
                    <div style="font-size:0.9rem; color:var(--text-muted);">مرحباً بك</div>
                    <div style="font-weight:700; color: var(--text-main);">المسؤول</div>
                </div>
                <div style="width:50px; height:50px; background: var(--color-dashboard); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-user" style="color: white;"></i>
                </div>
            </div>
        </header>

        <!-- 1. DASHBOARD -->
        <section id="dashboard" class="section active">
            <div class="dashboard-grid">
                
                <!-- KPI -->
                <div class="kpi-section">
                    <div class="kpi-card">
                        <div class="kpi-info"><h4>عدد المنتجات الكلي</h4><p id="kpi-total">0</p></div>
                        <i class="fas fa-layer-group kpi-icon" style="color: var(--color-dashboard);"></i>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-info"><h4>المنتجات الرابحة (Valid)</h4><p id="kpi-winning">0</p></div>
                        <i class="fas fa-check-circle kpi-icon" style="color: var(--color-winning);"></i>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-info"><h4>قيد الاستيراد</h4><p id="kpi-importing">0</p></div>
                        <i class="fas fa-shipping-fast kpi-icon" style="color: var(--color-shipping);"></i>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-info"><h4>إجمالي رأس المال المستثمر</h4><p id="kpi-capital">0 <span style="font-size:1.2rem; font-weight:500;">MAD</span></p></div>
                        <i class="fas fa-coins kpi-icon" style="color: var(--color-winning);"></i>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-info"><h4>إجمالي الربح المتوقع</h4><p id="kpi-profit">0 <span style="font-size:1.2rem; font-weight:500;">MAD</span></p></div>
                        <i class="fas fa-chart-line kpi-icon" style="color: var(--color-calc);"></i>
                    </div>
                </div>

                <!-- Actions -->
                <div class="actions-section">
                    <div class="actions-grid">
                        <div class="action-card act-blue" onclick="openModal('inventory')">
                            <i class="fas fa-plus-circle" style="color: var(--color-inventory);"></i>
                            <span>إضافة منتج للمخزون</span>
                        </div>
                        <div class="action-card act-green" onclick="openModal('winning')">
                            <i class="fas fa-trophy" style="color: var(--color-winning);"></i>
                            <span>إضافة منتج رابح</span>
                        </div>
                        <div class="action-card act-orange" onclick="openModal('importing')">
                            <i class="fas fa-shipping-fast" style="color: var(--color-shipping);"></i>
                            <span>إضافة منتج قيد الاستيراد</span>
                        </div>
                        <div class="action-card act-purple" onclick="openModal('pages')">
                            <i class="fas fa-store" style="color: var(--color-pages);"></i>
                            <span>إضافة صفحة ناجحة</span>
                        </div>
                        <div class="action-card" onclick="switchTab('calculator')">
                            <i class="fas fa-calculator" style="color: var(--color-calc);"></i>
                            <span>حاسبة الأرباح</span>
                        </div>
                    </div>
                </div>

                <!-- Winning -->
                <div class="card winning-section">
                    <div class="card-header">
                        <h3><i class="fas fa-trophy" style="color: var(--color-winning);"></i> أفضل المنتجات الرابحة</h3>
                    </div>
                    <div class="top-list" id="top-winning-list"></div>
                </div>

                <!-- Weak Products -->
                <div class="card weak-section">
                    <div class="card-header">
                        <h3><i class="fas fa-exclamation-triangle" style="color: var(--color-warning);"></i> تنبيهات (منتجات ضعيفة)</h3>
                    </div>
                    <div id="weak-alert-container"></div>
                </div>

                <!-- Pages -->
                <div class="card pages-section">
                    <div class="card-header">
                        <h3><i class="fas fa-link" style="color: var(--color-pages);"></i> أفضل الصفحات</h3>
                    </div>
                    <div id="best-pages-list"></div>
                </div>

            </div>
        </section>

        <!-- OTHER SECTIONS -->
        <section id="inventory" class="section">
            <div class="toolbar">
                <h2>إدارة المخزون</h2>
                <button class="btn btn-inventory" onclick="openModal('inventory')"><i class="fas fa-plus"></i> إضافة منتج</button>
            </div>
            <div id="inventory-list" class="card-grid-full"></div>
        </section>

        <section id="importing" class="section">
            <div class="toolbar">
                <h2>قيد الاستيراد</h2>
                <button class="btn btn-importing" onclick="openModal('importing')"><i class="fas fa-plus"></i> إضافة منتج</button>
            </div>
            <div id="importing-list" class="card-grid-full"></div>
        </section>

        <section id="winning" class="section">
            <div class="toolbar">
                <h2>المنتجات الرابحة</h2>
                <button class="btn btn-winning" onclick="openModal('winning')"><i class="fas fa-plus"></i> إضافة منتج رابح</button>
            </div>
            <div id="winning-list" class="card-grid-full"></div>
        </section>

        <section id="pages" class="section">
            <div class="toolbar">
                <h2>أفضل الصفحات</h2>
                <button class="btn btn-purple" onclick="openModal('pages')"><i class="fas fa-plus"></i> إضافة صفحة</button>
            </div>
            <div id="pages-list" class="card-grid-full"></div>
        </section>

        <section id="calculator" class="section">
            <div class="toolbar">
                <h2>حاسبة الأرباح</h2>
            </div>
            <div class="calc-wrapper">
                <div class="calc-inputs">
                    <div class="calc-group">
                        <label>ثمن شراء المنتج (MAD)</label>
                        <input type="number" id="calc-buy-price" placeholder="0.00" class="calc-control" oninput="calculateProfit()">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="calc-group">
                        <label>ثمن التوصيل (MAD)</label>
                        <input type="number" id="calc-delivery" placeholder="0.00" class="calc-control" oninput="calculateProfit()">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="calc-group">
                        <label>ثمن الإشهار / Ads (MAD)</label>
                        <input type="number" id="calc-ads" placeholder="0.00" class="calc-control" oninput="calculateProfit()">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div class="calc-group">
                        <label>هامش الربح المطلوب (MAD)</label>
                        <input type="number" id="calc-margin" placeholder="0.00" class="calc-control" oninput="calculateProfit()">
                        <i class="fas fa-percentage"></i>
                    </div>
                </div>
                
                <div class="calc-res">
                    <div class="res-box">
                        <h5>السعر النهائي للبيع</h5>
                        <span id="res-sale">0 <span>MAD</span></span>
                    </div>
                    <div class="res-box">
                        <h5>مجموع التكاليف</h5>
                        <span id="res-cost">0 <span>MAD</span></span>
                    </div>
                    <div class="res-box">
                        <h5>الربح الصافي</h5>
                        <span id="res-net">0 <span>MAD</span></span>
                    </div>
                    <div class="res-box">
                        <h5>السعر بالدولار (USD)</h5>
                        <span id="res-usd" style="font-size: 1.6rem; color: var(--text-muted);">$0.00</span>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- MODAL -->
    <div class="modal" id="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <h2 style="margin-bottom: 40px; font-weight: 700; color: var(--text-main);" id="modal-title">عنوان النافذة</h2>
            <div id="modal-form-body"></div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // --- STATE ---
        const db = {
            inventory: JSON.parse(localStorage.getItem('inventory')) || [],
            importing: JSON.parse(localStorage.getItem('importing')) || [],
            winning: JSON.parse(localStorage.getItem('winning')) || [],
            pages: JSON.parse(localStorage.getItem('pages')) || []
        };

        const USD_RATE = 9;
        const WEAK_PROFIT_THRESHOLD = 20; // أقل من 20 ربح يعتبر ضعيفاً
        const LOW_STOCK_THRESHOLD = 10;

        document.addEventListener('DOMContentLoaded', () => {
            renderDashboard();
            renderFullSections();
        });

        // --- NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if(tabId === 'dashboard') renderDashboard();
            if(tabId === 'inventory') renderInventory();
            if(tabId === 'importing') renderImporting();
            if(tabId === 'winning') renderWinning();
            if(tabId === 'pages') renderPages();
            if(tabId === 'calculator') {
                document.getElementById('calc-buy-price').value = '';
                document.getElementById('calc-delivery').value = '';
                document.getElementById('calc-ads').value = '';
                document.getElementById('calc-margin').value = '';
                calculateProfit();
            }

            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // --- DASHBOARD RENDERER ---
        function renderDashboard() {
            // KPI: العدد الكلي
            const total = db.inventory.length + db.importing.length + db.winning.length;
            document.getElementById('kpi-total').innerText = total;

            // KPI: الرابحة
            const winningValid = db.winning.filter(w => w.status === 'valid').length;
            document.getElementById('kpi-winning').innerText = winningValid;

            // KPI: الاستيراد
            const importing = db.importing.length;
            document.getElementById('kpi-importing').innerText = importing;

            // KPI: رأس المال
            let capital = 0;
            db.inventory.forEach(p => capital += (p.price * p.quantity));
            db.importing.forEach(p => capital += (p.price * p.quantity));
            db.winning.forEach(p => capital += (p.buyPrice * p.quantity));
            document.getElementById('kpi-capital').innerHTML = `${capital.toLocaleString()} <span>MAD</span>`;

            // KPI: الربح المتوقع
            let profit = 0;
            db.winning.forEach(p => profit += (p.margin * p.quantity));
            document.getElementById('kpi-profit').innerHTML = `${profit.toLocaleString()} <span>MAD</span>`;

            // 1. أفضل الرابحة
            const list = document.getElementById('top-winning-list');
            list.innerHTML = '';
            const sorted = [...db.winning].filter(p => p.status === 'valid').sort((a, b) => b.margin - a.margin).slice(0, 5);
            if(sorted.length === 0) list.innerHTML = '<div style="text-align:center; color:#cbd5e1; padding:30px;">لا توجد منتجات رابحة</div>';
            else {
                sorted.forEach(p => {
                    list.innerHTML += `
                        <div class="top-item">
                            <div class="item-info">
                                <img src="${p.image || 'https://via.placeholder.com/70'}" class="item-img">
                                <div>
                                    <div class="item-name">${p.name}</div>
                                    <div class="item-sub">مبيع: ${p.salePrice} MAD</div>
                                </div>
                            </div>
                            <div class="item-metrics">
                                <div class="metric-badge">+${p.margin} MAD (صافي)</div>
                                <div style="display:flex;">
                                    <button class="btn-icon bg-green" onclick="toggleStatus(${p.id})"><i class="fas fa-check"></i></button>
                                    <button class="btn-icon bg-red" onclick="deleteItem('winning', ${p.id})"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // 2. المنتجات الضعيفة (Weak Products Logic)
            const weakContainer = document.getElementById('weak-alert-container');
            weakContainer.innerHTML = '';
            const weakProducts = db.winning.filter(p => p.status === 'valid' && p.margin < WEAK_PROFIT_THRESHOLD);
            if(weakProducts.length === 0) weakContainer.innerHTML = '<div style="text-align:center; color:#cbd5e1; padding:20px;">لا توجد تنبيهات، جميع المنتجات قوية</div>';
            else {
                weakProducts.forEach(p => {
                    let note = p.margin < 0 ? 'خسارة' : 'ربح ضعيف';
                    weakContainer.innerHTML += `
                        <div class="weak-row">
                            <strong>${p.name}</strong>
                            <span>${note} (${p.margin} MAD)</span>
                        </div>
                    `;
                });
            }

            // 3. أفضل الصفحات
            const pagesContainer = document.getElementById('best-pages-list');
            pagesContainer.innerHTML = '';
            if(db.pages.length === 0) pagesContainer.innerHTML = '<div style="text-align:center; color:#cbd5e1; padding:20px;">لم يتم حفظ أي صفحة</div>';
            else {
                db.pages.forEach(p => {
                    pagesContainer.innerHTML += `
                        <a href="${p.link}" target="_blank" class="page-link">
                            <span>${p.name}</span>
                            <i class="fas fa-external-link-alt page-icon"></i>
                        </a>
                    `;
                });
            }
        }

        // --- FULL SECTIONS RENDERERS ---
        function renderFullSections() {
            renderInventory();
            renderImporting();
            renderWinning();
            renderPages();
        }

        function renderInventory() {
            const container = document.getElementById('inventory-list');
            container.innerHTML = db.inventory.length ? '' : '<div class="empty-state">المخزون فارغ</div>';
            db.inventory.forEach(item => {
                const isAvailable = item.quantity > 0;
                const badge = isAvailable ? '<span class="badge badge-success">متوفر</span>' : '<span class="badge badge-danger">نفذت</span>';
                
                container.innerHTML += `
                    <div class="product-card" style="border-right: 5px solid var(--color-inventory);">
                        <img src="${item.image || 'https://via.placeholder.com/300x220?text=No+Image'}" class="product-img">
                        <div class="product-body">
                            <div class="product-title">${item.name}</div>
                            <div class="product-meta"><span>الكمية: ${item.quantity}</span><span>السعر: ${item.price} MAD</span></div>
                            <div class="product-meta"><span>الاستثمار: ${(item.price * item.quantity).toFixed(1)}</span>${badge}</div>
                            <div class="status-text status-success">${isAvailable ? 'متوفر في المخزون' : 'غير متوفر'}</div>
                        </div>
                        <div class="product-actions">
                            <button class="btn-icon-sm" style="background:var(--color-dashboard); color:white;" onclick="showPreview('inventory', ${item.id})"><i class="fas fa-eye"></i></button>
                            <button class="btn-icon-sm" style="background:var(--color-edit); color:white;" onclick="openModal('inventory', ${item.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon-sm" style="background:var(--color-delete); color:white;" onclick="deleteItem('inventory', ${item.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        function renderImporting() {
            const container = document.getElementById('importing-list');
            container.innerHTML = db.importing.length ? '' : '<div class="empty-state">لا توجد واردات</div>';
            db.importing.forEach(item => {
                container.innerHTML += `
                    <div class="product-card" style="border-right: 5px solid var(--color-shipping);">
                        <img src="${item.image || 'https://via.placeholder.com/300x220?text=No+Image'}" class="product-img">
                        <div class="product-body">
                            <div class="product-title">${item.name}</div>
                            <div class="product-meta"><span>الكمية: ${item.quantity}</span><span>السعر: ${item.price} MAD</span></div>
                            <div class="product-meta"><span>الاستثمار: ${(item.price * item.quantity).toFixed(1)}</span><span class="badge badge-warning">قيد الاستيراد</span></div>
                            <div class="status-text" style="color:var(--color-shipping)">قيد التوصيل للمستودع</div>
                            ${item.notes ? `<div style="margin-top:8px; font-size:0.85rem; color:var(--text-muted); background:#f9fafb; padding:8px; border-radius:6px;">${item.notes}</div>` : ''}
                        </div>
                        <div class="product-actions">
                            <button class="btn-icon-sm" style="background:var(--color-edit); color:white;" onclick="openModal('importing', ${item.id})"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon-sm" style="background:var(--color-delete); color:white;" onclick="deleteItem('importing', ${item.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        function renderWinning() {
            const container = document.getElementById('winning-list');
            container.innerHTML = db.winning.length ? '' : '<div class="empty-state">لم يتم إضافة منتجات رابحة</div>';
            db.winning.forEach(item => {
                const statusBadge = item.status === 'valid' ? '<span class="badge badge-success">Valid</span>' : '<span class="badge badge-danger">Invalid</span>';
                const statusText = item.status === 'valid' ? 'منتج رابح' : 'منتج فاشل';
                
                container.innerHTML += `
                    <div class="product-card" style="border-right: 5px solid var(--color-winning);">
                        <img src="${item.image || 'https://via.placeholder.com/300x220?text=No+Image'}" class="product-img">
                        <div class="product-body">
                            <div class="product-title">${item.name}</div>
                            <div class="product-meta"><span>شراء: ${item.buyPrice}</span><span>بيع: ${item.salePrice}</span></div>
                            <div class="product-meta"><span>الربح الصافي: ${item.margin} MAD</span>${statusBadge}</div>
                            <div class="status-text" style="color:${item.status === 'valid' ? 'var(--color-success)' : 'var(--color-delete)'}">${statusText}</div>
                            <div style="margin-top:12px; display:flex; gap:10px;">
                                ${item.alibaba ? `<a href="${item.alibaba}" target="_blank" style="color:var(--color-shipping); font-size:0.9rem; font-weight:700;"><i class="fas fa-link"></i> Alibaba</a>` : ''}
                                ${item.store ? `<a href="${item.store}" target="_blank" style="color:var(--color-dashboard); font-size:0.9rem; font-weight:700;"><i class="fas fa-link"></i> Store</a>` : ''}
                            </div>
                        </div>
                        <div class="product-actions">
                            <button class="btn-icon-sm" style="background:var(--color-edit); color:white;" onclick="toggleStatus(${item.id})"><i class="fas fa-exchange-alt"></i></button>
                            <button class="btn-icon-sm" style="background:var(--color-edit); color:white;" onclick="openModal('winning', ${item.id})"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon-sm" style="background:var(--color-delete); color:white;" onclick="deleteItem('winning', ${item.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        function renderPages() {
            const container = document.getElementById('pages-list');
            container.innerHTML = db.pages.length ? '' : '<div class="empty-state">لم يتم إضافة أي صفحة</div>';
            db.pages.forEach(item => {
                container.innerHTML += `
                    <div class="product-card" style="border-right: 5px solid var(--color-pages);">
                        <div class="product-body">
                            <div class="product-title">${item.name}</div>
                            <a href="${item.link}" target="_blank" style="color:var(--color-pages); text-decoration:none; font-weight:700; font-size:1rem; display:block; margin-bottom:15px;">
                                <i class="fas fa-external-link-alt"></i> زيارة الصفحة
                            </a>
                            <p style="font-size:0.9rem; color:var(--text-muted); line-height:1.5;">${item.notes || 'لا توجد ملاحظات'}</p>
                        </div>
                        <div class="product-actions">
                            <button class="btn-icon-sm" style="background:var(--color-edit); color:white;" onclick="openModal('pages', ${item.id})"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon-sm" style="background:var(--color-delete); color:white;" onclick="deleteItem('pages', ${item.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        // --- CALCULATOR ---
        function calculateProfit() {
            const buy = parseFloat(document.getElementById('calc-buy-price').value) || 0;
            const delivery = parseFloat(document.getElementById('calc-delivery').value) || 0;
            const ads = parseFloat(document.getElementById('calc-ads').value) || 0;
            const margin = parseFloat(document.getElementById('calc-margin').value) || 0;

            const totalCost = buy + delivery + ads;
            const salePrice = buy + delivery + ads + margin;
            const usdPrice = salePrice / USD_RATE;

            document.getElementById('res-sale').innerHTML = `${salePrice.toFixed(2)} <span>MAD</span>`;
            document.getElementById('res-cost').innerHTML = `${totalCost.toFixed(2)} <span>MAD</span>`;
            document.getElementById('res-net').innerHTML = `${margin.toFixed(2)} <span>MAD</span>`;
            document.getElementById('res-usd').innerText = `$${usdPrice.toFixed(2)}`;
        }

        // --- MODAL LOGIC ---
        let currentModalType = '';
        let editingId = null;
        let tempImage = '';

        function openModal(type, id = null) {
            currentModalType = type;
            editingId = id;
            tempImage = '';
            
            const modalTitle = document.getElementById('modal-title');
            const formBody = document.getElementById('modal-form-body');
            const modal = document.getElementById('modal-overlay');
            modal.classList.add('open');
            formBody.innerHTML = '';

            let data = {};
            if (id) {
                if(type === 'inventory') data = db.inventory.find(i => i.id === id);
                if(type === 'importing') data = db.importing.find(i => i.id === id);
                if(type === 'winning') data = db.winning.find(i => i.id === id);
                if(type === 'pages') data = db.pages.find(i => i.id === id);
                tempImage = data.image || '';
            }

            modalTitle.innerText = id ? 'تعديل ' + getTitle(type) : 'إضافة ' + getTitle(type);

            // Inventory Form
            if (type === 'inventory') {
                formBody.innerHTML = `
                    <div class="image-preview" onclick="document.getElementById('file-upload').click()">
                        ${tempImage ? `<img src="${tempImage}">` : '<div class="image-preview-placeholder"><i class="fas fa-camera fa-2x"></i><br>اضغط لرفع صورة</div></div>'}
                    </div>
                    <input type="file" id="file-upload" style="display:none" accept="image/*" onchange="handleImageUpload(this)">
                    
                    <div class="form-group">
                        <label class="form-label">اسم المنتج</label>
                        <input type="text" id="inp-name" class="form-input" placeholder="مثلاً: قميص مانيكي" value="${data.name || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">الكمية</label>
                        <input type="number" id="inp-qty" class="form-input" value="${data.quantity || 0}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ثمن الاستثمار/الوحدة (MAD)</label>
                        <input type="number" id="inp-price" class="form-input" value="${data.price || 0}" placeholder="سعر شراء المنتج">
                    </div>
                    <button class="btn btn-inventory" style="width:100%; margin-top:10px;" onclick="saveItem()"><i class="fas fa-save"></i> حفظ</button>
                `;
            } 
            // Importing Form
            else if (type === 'importing') {
                formBody.innerHTML = `
                    <div class="image-preview" onclick="document.getElementById('file-upload').click()">
                        ${tempImage ? `<img src="${tempImage}">` : '<div class="image-preview-placeholder"><i class="fas fa-camera fa-2x"></i><br>اضغط لرفع صورة</div></div>'}
                    </div>
                    <input type="file" id="file-upload" style="display:none" accept="image/*" onchange="handleImageUpload(this)">

                    <div class="form-group">
                        <label class="form-label">اسم المنتج</label>
                        <input type="text" id="inp-name" class="form-input" value="${data.name || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">الكمية</label>
                        <input type="number" id="inp-qty" class="form-input" value="${data.quantity || 0}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ثمن الاستثمار/الوحدة (MAD)</label>
                        <input type="number" id="inp-price" class="form-input" value="${data.price || 0}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ملاحظات (اختياري)</label>
                        <textarea id="inp-notes" class="form-textarea" rows="3">${data.notes || ''}</textarea>
                    </div>
                    <button class="btn btn-importing" style="width:100%; margin-top:10px;" onclick="saveItem()"><i class="fas fa-save"></i> حفظ</button>
                `;
            }
            // Winning Form
            else if (type === 'winning') {
                formBody.innerHTML = `
                    <div class="image-preview" onclick="document.getElementById('file-upload').click()">
                        ${tempImage ? `<img src="${tempImage}">` : '<div class="image-preview-placeholder"><i class="fas fa-camera fa-2x"></i><br>اضغط لرفع صورة</div></div>'}
                    </div>
                    <input type="file" id="file-upload" style="display:none" accept="image/*" onchange="handleImageUpload(this)">

                    <div class="form-group"><label class="form-label">اسم المنتج</label><input type="text" id="inp-name" class="form-input" value="${data.name || ''}"></div>
                    <div class="form-group"><label class="form-label">سعر الشراء (MAD)</label><input type="number" id="inp-buy" class="form-input" value="${data.buyPrice || 0}"></div>
                    <div class="form-group"><label class="form-label">سعر البيع (MAD)</label><input type="number" id="inp-sale" class="form-input" value="${data.salePrice || 0}"></div>
                    <div class="form-group">
                        <label class="form-label">هامش الربح (MAD) <span style="font-size:0.8rem; color:#94a3b8; font-weight:400;">(يحسب تلقائياً)</span></label>
                        <input type="number" id="inp-margin" class="form-input" value="${data.margin || ''}" placeholder="سيتم الحساب تلقائياً إن تركه فارغاً">
                    </div>
                    <div class="form-group"><label class="form-label">رابط Alibaba</label><input type="text" id="inp-alibaba" class="form-input" value="${data.alibaba || ''}"></div>
                    <div class="form-group"><label class="form-label">رابط المتجر</label><input type="text" id="inp-store" class="form-input" value="${data.store || ''}"></div>
                    <div class="form-group"><label class="form-label">الحالة</label>
                        <select id="inp-status" class="form-input">
                            <option value="valid" ${data.status === 'valid' ? 'selected' : ''}>Valid (ناجح)</option>
                            <option value="invalid" ${data.status === 'invalid' ? 'selected' : ''}>Invalid (فاشل)</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">الكمية</label><input type="number" id="inp-qty" class="form-input" value="${data.quantity || 0}"></div>
                    <button class="btn btn-winning" style="width:100%; margin-top:10px;" onclick="saveItem()"><i class="fas fa-save"></i> حفظ</button>
                `;
            }
            // Pages Form
            else if (type === 'pages') {
                formBody.innerHTML = `
                    <div class="form-group"><label class="form-label">اسم الصفحة</label><input type="text" id="inp-name" class="form-input" value="${data.name || ''}"></div>
                    <div class="form-group"><label class="form-label">رابط الصفحة</label><input type="text" id="inp-link" class="form-input" value="${data.link || ''}"></div>
                    <div class="form-group"><label class="form-label">ملاحظات</label><textarea id="inp-notes" class="form-textarea" rows="3">${data.notes || ''}</textarea></div>
                    <button class="btn btn-purple" style="width:100%; margin-top:10px;" onclick="saveItem()"><i class="fas fa-save"></i> حفظ</button>
                `;
            }
        }

        function getTitle(type) {
            if(type === 'inventory') return 'منتج مخزون';
            if(type === 'importing') return 'منتج مستورد';
            if(type === 'winning') return 'منتج رابح';
            if(type === 'pages') return 'صفحة';
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('open');
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempImage = e.target.result;
                    input.previousElementSibling.innerHTML = `<img src="${tempImage}">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- SAVE LOGIC ---
        function saveItem() {
            // Inventory
            if(currentModalType === 'inventory') {
                const name = document.getElementById('inp-name').value;
                const qty = parseInt(document.getElementById('inp-qty').value);
                const price = parseFloat(document.getElementById('inp-price').value);
                
                if(!name) { alert('الاسم مطلوب'); return; }

                const item = {
                    id: editingId || Date.now(),
                    name, quantity: qty, price, image: tempImage
                };

                if (editingId) {
                    const idx = db.inventory.findIndex(i => i.id === editingId);
                    db.inventory[idx] = item;
                    showToast('تم التعديل بنجاح');
                } else {
                    db.inventory.push(item);
                    showToast('تمت الإضافة بنجاح');
                }
            }
            // Importing
            else if(currentModalType === 'importing') {
                const name = document.getElementById('inp-name').value;
                const qty = parseInt(document.getElementById('inp-qty').value);
                const price = parseFloat(document.getElementById('inp-price').value);
                const notes = document.getElementById('inp-notes').value;

                if(!name) { alert('الاسم مطلوب'); return; }

                const item = {
                    id: editingId || Date.now(),
                    name, quantity: qty, price, image: tempImage, notes
                };

                if (editingId) {
                    const idx = db.importing.findIndex(i => i.id === editingId);
                    db.importing[idx] = item;
                    showToast('تم التعديل بنجاح');
                } else {
                    db.importing.push(item);
                    showToast('تمت الإضافة بنجاح');
                }
            }
            // Winning
            else if (currentModalType === 'winning') {
                const name = document.getElementById('inp-name').value;
                const buy = parseFloat(document.getElementById('inp-buy').value) || 0;
                const sale = parseFloat(document.getElementById('inp-sale').value) || 0;
                let margin = parseFloat(document.getElementById('inp-margin').value);
                if(isNaN(margin)) margin = sale - buy; // Auto calc margin if empty
                
                const alibaba = document.getElementById('inp-alibaba').value;
                const store = document.getElementById('inp-store').value;
                const qty = parseInt(document.getElementById('inp-qty').value) || 1;
                const status = document.getElementById('inp-status').value;

                if(!name) { alert('الاسم مطلوب'); return; }

                const item = {
                    id: editingId || Date.now(),
                    name, buyPrice: buy, salePrice: sale, margin,
                    alibaba, store, image: tempImage, status, quantity: qty
                };

                if (editingId) {
                    const idx = db.winning.findIndex(i => i.id === editingId);
                    db.winning[idx] = item;
                    showToast('تم التعديل بنجاح');
                } else {
                    db.winning.push(item);
                    showToast('تمت الإضافة بنجاح');
                }
            }
            // Pages
            else if (currentModalType === 'pages') {
                const name = document.getElementById('inp-name').value;
                const link = document.getElementById('inp-link').value;
                const notes = document.getElementById('inp-notes').value;

                if(!name || !link) { alert('الاسم والرابط مطلوبان'); return; }

                const item = { id: editingId || Date.now(), name, link, notes };
                if (editingId) {
                    const idx = db.pages.findIndex(i => i.id === editingId);
                    db.pages[idx] = item;
                } else {
                    db.pages.push(item);
                }
            }

            updateDB();
            closeModal();
            renderDashboard();
            renderFullSections();
        }

        // --- DELETE LOGIC ---
        function deleteItem(type, id) {
            if(confirm('هل أنت متأكد من الحذف؟')) {
                if(type === 'inventory') { db.inventory = db.inventory.filter(i => i.id !== id); renderInventory(); }
                if(type === 'importing') { db.importing = db.importing.filter(i => i.id !== id); renderImporting(); }
                if(type === 'winning') { db.winning = db.winning.filter(i => i.id !== id); renderWinning(); }
                if(type === 'pages') { db.pages = db.pages.filter(i => i.id !== id); renderPages(); }
                
                updateDB();
                renderDashboard();
                showToast('تم الحذف بنجاح');
            }
        }

        function toggleStatus(id) {
            const item = db.winning.find(i => i.id === id);
            if(item) {
                item.status = item.status === 'valid' ? 'invalid' : 'valid';
                updateDB();
                renderWinning();
                renderDashboard();
                showToast('تم تغيير الحالة');
            }
        }

        function showPreview(type, id) {
            openModal(type, id);
            const btn = document.querySelector('#modal-form-body button');
            if(btn) { btn.innerText = 'إغلاق'; btn.onclick = closeModal; }
        }

        // --- DB SYNC ---
        function updateDB() {
            localStorage.setItem('inventory', JSON.stringify(db.inventory));
            localStorage.setItem('importing', JSON.stringify(db.importing));
            localStorage.setItem('winning', JSON.stringify(db.winning));
            localStorage.setItem('pages', JSON.stringify(db.pages));
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas fa-check-circle" style="color:white;"></i> ${msg}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
